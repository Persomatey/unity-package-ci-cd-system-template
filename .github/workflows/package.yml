name: Build and Release Unity Package

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  PROJECT_PATH: unity_project
  PACKAGE_NAME: com.yourcompany.packagename

jobs:
  determineVersion:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.tag }}
      package_version: ${{ steps.version.outputs.package_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: version
        run: |
          git fetch --tags
          last_tag=$(git tag | grep '^v' | sort -V | tail -n1)
          [ -z "$last_tag" ] && last_tag="v0.0.0"

          base=${last_tag%.*}
          patch=${last_tag##*.}
          next_tag="${base}.$((patch + 1))"

          echo "tag=$next_tag" >> $GITHUB_OUTPUT
          echo "package_version=${next_tag#v}" >> $GITHUB_OUTPUT

  validatePackage:
    runs-on: ubuntu-22.04
    needs: determineVersion
    steps:
      - uses: actions/checkout@v4

      - name: Validate package structure
        run: |
          set -euo pipefail
      
          PACKAGE_PATH="$PROJECT_PATH/Packages/$PACKAGE_NAME"
      
          echo "Validating package at: $PACKAGE_PATH"
      
          if [ ! -d "$PACKAGE_PATH/Runtime" ]; then
            echo "::error ::Runtime folder missing!"
            exit 1
          fi
      
          if [ ! -f "$PACKAGE_PATH/package.json" ]; then
            echo "::error ::package.json missing!"
            exit 1
          fi
      
          echo "Package structure OK"

  pushUpm:
    runs-on: ubuntu-22.04
    needs: [determineVersion, validatePackage]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update package.json version
        run: |
          PACKAGE_JSON="$PROJECT_PATH/Packages/$PACKAGE_NAME/package.json"
          VERSION="${{ needs.determineVersion.outputs.package_version }}"
  
          echo "Setting package.json version to $VERSION"
  
          jq ".version = \"$VERSION\"" "$PACKAGE_JSON" > package.json.tmp
          mv package.json.tmp "$PACKAGE_JSON"

      - name: Prepare UPM package structure
        shell: bash
        run: |
          set -e
      
          SRC="$PROJECT_PATH/Packages/$PACKAGE_NAME"
          OUT=$(mktemp -d)
      
          echo "Preparing UPM package from $SRC → $OUT"
      
          # Copy everything except Samples
          rsync -av \
            --exclude="Samples" \
            "$SRC/" \
            "$OUT/"
      
          # Convert Samples → Samples~
          if [ -d "$SRC/Samples" ]; then
            mkdir -p "$OUT/Samples~"
            rsync -av "$SRC/Samples/" "$OUT/Samples~/"
      
            # Remove orphaned Samples.meta if present
            rm -f "$OUT/Samples.meta"
      
            # Ensure Samples~.meta exists
            if [ ! -f "$OUT/Samples~.meta" ]; then
              cat > "$OUT/Samples~.meta" <<EOF
            fileFormatVersion: 2
            guid: $(uuidgen | tr -d '-')
            folderAsset: yes
            DefaultImporter:
              externalObjects: {}
              userData:
              assetBundleName:
              assetBundleVariant:
              EOF
                fi
              fi
          
              echo "UPM package prepared at $OUT"
              echo "UPM_OUT=$OUT" >> $GITHUB_ENV

      - name: Push package to upm branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"
      
          PACKAGE_SRC="$PROJECT_PATH/Packages/$PACKAGE_NAME"
      
          echo "Publishing package from: $PACKAGE_SRC"
      
          if [ ! -f "$PACKAGE_SRC/package.json" ]; then
            echo "::error ::package.json not found in $PACKAGE_SRC"
            exit 1
          fi
      
          # Save package contents
          TMP_DIR=$(mktemp -d)
          cp -R "$PACKAGE_SRC/." "$TMP_DIR/"
      
          # Create fresh upm branch
          git checkout --orphan upm
          git rm -rf . || true
      
          # Copy package contents to repo root
          cp -R "$TMP_DIR/." .
      
          git add .
          git commit -m "Release ${{ needs.determineVersion.outputs.package_version }}"
          git push -f origin upm

  createRelease:
    runs-on: ubuntu-22.04
    needs: [determineVersion, pushUpm]
    steps:
      - uses: actions/checkout@v4

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.determineVersion.outputs.version }}
          name: Release ${{ needs.determineVersion.outputs.version }}
          body: |
            Install via Package Manager:

            https://github.com/${{ github.repository }}.git#upm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
