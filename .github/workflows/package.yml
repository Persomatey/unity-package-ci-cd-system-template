name: Build and Release Unity Package

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  PROJECT_PATH: unity_project
  PACKAGE_NAME: com.yourcompany.packagename
  PACKAGE_PATH: ${{ env.PROJECT_PATH }}/Packages/${{ env.PACKAGE_NAME }}


jobs:
  determineVersion:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.tag }}
      package_version: ${{ steps.version.outputs.package_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: version
        run: |
          git fetch --tags
          last_tag=$(git tag | grep '^v' | sort -V | tail -n1)
          [ -z "$last_tag" ] && last_tag="v0.0.0"

          base=${last_tag%.*}
          patch=${last_tag##*.}
          next_tag="${base}.$((patch + 1))"

          echo "tag=$next_tag" >> $GITHUB_OUTPUT
          echo "package_version=${next_tag#v}" >> $GITHUB_OUTPUT

  validatePackage:
    runs-on: ubuntu-22.04
    needs: determineVersion
    steps:
      - uses: actions/checkout@v4

      - name: Validate package structure
        run: |
          if [ ! -d "${{ env.PACKAGE_PATH }}/Runtime" ]; then
            echo "::error ::Runtime folder missing!"
            exit 1
          fi
      
          if [ ! -f "${{ env.PACKAGE_PATH }}/package.json" ]; then
            echo "::error ::package.json missing!"
            exit 1
          fi
      
          echo "Package structure OK"


  pushUpm:
    runs-on: ubuntu-22.04
    needs: [determineVersion, validatePackage]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push package to upm branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"
      
          # Make temporary folder to save package
          TMP_DIR=$(mktemp -d)
          echo "Saving package from $PACKAGE_PATH to $TMP_DIR"
          cp -r "$PACKAGE_PATH" "$TMP_DIR/"
      
          # Switch to orphan upm branch
          git checkout --orphan upm
      
          # Remove everything from current working tree (except .git)
          git rm -rf . || true
      
          # Recreate Packages folder and copy package back
          mkdir -p Packages
          cp -r "$TMP_DIR/$(basename $PACKAGE_PATH)" Packages/
      
          # Add, commit, and push
          git add .
          git commit -m "Release ${{ needs.determineVersion.outputs.package_version }}"
          git push -f origin upm

  createRelease:
    runs-on: ubuntu-22.04
    needs: [determineVersion, pushUpm]
    steps:
      - uses: actions/checkout@v4

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.determineVersion.outputs.version }}
          name: Release ${{ needs.determineVersion.outputs.version }}
          body: |
            Install via Package Manager:

            https://github.com/${{ github.repository }}.git#upm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
